OFILE=/usr/local/etc/dnsmasq.more.conf
TMPFILE=/usr/local/etc/dnsmasq.more.conf.tmp
cp ${OFILE} ${OFILE}.bak
wc -l ${OFILE}*
>$OFILE
>$TMPFILE
counter=1
while read line; do
  pattern=$(echo $line | cut -f 1 -d "|")
  url=$(echo $line | cut -f 2 -d "|")
  echo "curl $url | sed $pattern"
  if [ x$pattern == "xNXDOMAIN" ];then
    continue
  fi

  echo "### $url" >>${TMPFILE}
  if [ x$pattern == "xcsv" ];then
    curl -s $url | cut -d ',' -f 3 | sed -E '{s#"#address=/#;s#"$#/127.0.0.1#;}' >>$TMPFILE
  elif [ x$pattern == "xpipes" ];then
    curl -s $url | cut -d ',' -f 3 | sed -E '{s#^\|\|#address=/#;s#\^$#/127.0.0.1#;}' >>$TMPFILE
  else
    #curl -s $url | sed -E '{/^#/d;/^$/d;s#'"$pattern"'#address=/#;s%#.*$%%;s#/([^/]*).*$#/\1#;s#[[:space:]]##g;s#$#/127.0.0.1#;}' >>$TMPFILE
    curl -s $url | grep $pattern | sed -E '{/^#/d;/^$/d;s#'"$pattern"'#address=/#;s%#.*$%%;s#(/[^/]*).*$#\1#;s#[[:space:]]##g;s#$#/127.0.0.1#;}' >>$TMPFILE
  fi
  #if [ $counter -eq $1 ];then
  #  exit 1
  #fi
  counter=$(expr $counter + 1)
done <blocklists

#sed -i.b4clean '{/^address=\/\/127.0.0.1$/d;}' $TMPFILE

# ... apply whitelist
while read line; do
  sed -i.b4whitelist '{/^address=\/'"$line"'\//d;}' $TMPFILE
done <whitelist

# ... sanitize
sed -E -i.b4sanitize '/address=\/([0-9]{1,3}\.?){4}\//d' $TMPFILE
sed -i.b4sanitize2 '/address=\/[^\.]*127.0.0.1$/d' $TMPFILE

# ... unique entries
sort -u -o ${OFILE} ${TMPFILE}

wc -l ${OFILE}*

